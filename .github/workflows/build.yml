name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup CMake
        uses: lukka/get-cmake@latest
      
      - name: Build
        run: .\build-windows.ps1 -Architecture ${{ matrix.arch }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: build/windows-${{ matrix.arch }}/bin/Release/*.dll

  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git
      
      - name: Setup ARM64 cross-compilation
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          echo "CMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/cmake/toolchain-linux-arm64.cmake" >> $GITHUB_ENV
      
      - name: Build
        run: |
          chmod +x build-linux.sh
          ./build-linux.sh ${{ matrix.arch }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: build/linux-${{ matrix.arch }}/lib/*.so

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup CMake
        uses: lukka/get-cmake@latest
      
      - name: Build
        run: |
          chmod +x build-macos.sh
          ./build-macos.sh ${{ matrix.arch }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: build/macos-${{ matrix.arch }}/lib/*.dylib

  create-nuget:
    needs: [build-windows, build-linux, build-macos]
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: build
      
      - name: Reorganize artifacts
        shell: pwsh
        run: |
          # Show what we downloaded
          Write-Host "=== Downloaded artifacts structure ==="
          Get-ChildItem -Recurse build | Select-Object FullName
          
          # Create target directories
          New-Item -ItemType Directory -Force -Path "build/windows-x64/bin/Release"
          New-Item -ItemType Directory -Force -Path "build/windows-x86/bin/Release"
          New-Item -ItemType Directory -Force -Path "build/linux-x64/lib"
          New-Item -ItemType Directory -Force -Path "build/linux-arm64/lib"
          New-Item -ItemType Directory -Force -Path "build/osx-x64/lib"
          New-Item -ItemType Directory -Force -Path "build/osx-arm64/lib"
          
          # Copy Windows binaries
          Copy-Item "build/windows-x64/*.dll" "build/windows-x64/bin/Release/" -Force
          Copy-Item "build/windows-x86/*.dll" "build/windows-x86/bin/Release/" -Force
          
          # Copy Linux binaries
          Copy-Item "build/linux-x64/*.so" "build/linux-x64/lib/" -Force
          Copy-Item "build/linux-arm64/*.so" "build/linux-arm64/lib/" -Force
          
          # Copy macOS binaries (artifact name is macos-*, but .csproj expects osx-*)
          Copy-Item "build/macos-x64/*.dylib" "build/osx-x64/lib/" -Force
          Copy-Item "build/macos-arm64/*.dylib" "build/osx-arm64/lib/" -Force
          
          Write-Host "=== Files ready for packing ==="
          Get-ChildItem -Recurse build/windows-x64, build/windows-x86, build/linux-x64, build/linux-arm64, build/osx-x64, build/osx-arm64 | Select-Object FullName
      
      - name: Determine version
        id: get_version
        shell: pwsh
        run: |
          # Base version from latest tag or default
          $baseVersion = "78.1.0"
          
          if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
            # Release build from tag
            $version = $matches[1]
            echo "VERSION=$version" >> $env:GITHUB_OUTPUT
            echo "IS_RELEASE=true" >> $env:GITHUB_OUTPUT
          } elseif ("${{ github.ref }}" -eq "refs/heads/main" -or "${{ github.ref }}" -eq "refs/heads/master") {
            # CI build from main branch
            $version = "$baseVersion-ci${{ github.run_number }}"
            echo "VERSION=$version" >> $env:GITHUB_OUTPUT
            echo "IS_RELEASE=false" >> $env:GITHUB_OUTPUT
          } else {
            # Dev build from feature branch
            $version = "$baseVersion-dev${{ github.run_number }}"
            echo "VERSION=$version" >> $env:GITHUB_OUTPUT
            echo "IS_RELEASE=false" >> $env:GITHUB_OUTPUT
          }
          Write-Host "Package version: $version"
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Create NuGet package
        shell: pwsh
        run: |
          # Pack with the determined version
          dotnet pack src/IcuBreakIterator.Net/IcuBreakIterator.Net.csproj `
            -c Release `
            -p:Version=${{ steps.get_version.outputs.VERSION }} `
            -o packages
      
      - name: Upload NuGet package artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: packages/*.nupkg
      
      - name: Publish to NuGet
        if: steps.get_version.outputs.IS_RELEASE == 'true'
        shell: pwsh
        run: |
          dotnet nuget push packages/IcuBreakIterator.Native.${{ steps.get_version.outputs.VERSION }}.nupkg `
            --api-key ${{ secrets.NUGET_API_KEY }} `
            --source https://api.nuget.org/v3/index.json `
            --skip-duplicate
        continue-on-error: true
      
      - name: Create Release
        if: steps.get_version.outputs.IS_RELEASE == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: packages/IcuBreakIterator.Native.${{ steps.get_version.outputs.VERSION }}.nupkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
